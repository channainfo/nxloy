// Viral Challenges Domain
// Models: Challenge, ChallengeParticipation, ChallengeLeaderboard
//
// Purpose: Enable AI-powered viral challenge creation with trend analysis.
// Businesses create challenges (manual or AI-generated), customers participate,
// share on social media, and earn rewards. Designed for maximum virality.

// ============================================================================
// CHALLENGES
// ============================================================================

enum ChallengeType {
  PURCHASE // Buy X products
  REVIEW // Leave X reviews
  PHOTO_UPLOAD // Upload X photos
  VIDEO_UPLOAD // Upload X videos
  SOCIAL_SHARE // Share on social media
  REFERRAL // Refer X friends
  CHECK_IN // Visit store X times
  COMBO // Combination of multiple tasks
  CUSTOM // Business-defined custom challenge
}

enum ChallengeStatus {
  DRAFT // Being created, not live
  SCHEDULED // Scheduled for future start
  ACTIVE // Currently running
  PAUSED // Temporarily paused
  COMPLETED // Ended normally
  CANCELLED // Cancelled before completion
}

enum TrendSource {
  TIKTOK // Trending on TikTok
  INSTAGRAM // Trending on Instagram
  TWITTER // Trending on Twitter/X
  YOUTUBE // Trending on YouTube
  AI_GENERATED // Generated by AI trend analysis
  MANUAL // Manually created by business
}

model Challenge {
  id String @id @default(cuid())

  // Multi-tenant
  businessId String

  // Challenge metadata
  name        String // "Latte Art Challenge", "Summer Vibes Photo Contest"
  description String // Full description
  type        ChallengeType
  status      ChallengeStatus @default(DRAFT)

  // Viral mechanics
  hashtag     String? // #BeanBrewArt, #SummerVibesContest
  trendSource TrendSource @default(MANUAL)
  trendData   Json? // AI trend analysis data
  // Example: {
  //   "platform": "tiktok",
  //   "trendingSound": "sound_id_123",
  //   "trendingHashtag": "#LatteArtChallenge",
  //   "estimatedReach": 500000,
  //   "trendPeakDate": "2025-11-15",
  //   "viralCoefficient": 0.85
  // }

  // Challenge tasks
  tasks Json // Array of task objects
  // Example: [
  //   {"type": "purchase", "quantity": 1, "productIds": ["prod_123"]},
  //   {"type": "photo_upload", "quantity": 1, "requirements": {"minQuality": 70}},
  //   {"type": "social_share", "platforms": ["instagram", "tiktok"], "requiredHashtags": ["#BrandName"]}
  // ]

  // Rewards
  rewards Json // Reward structure
  // Example: {
  //   "completion": {"points": 500, "badge": "latte_artist"},
  //   "topPerformers": {"1st": {"points": 2000, "prize": "Free month"}, "2nd": {...}, "3rd": {...}},
  //   "participation": {"points": 100}
  // }

  // Time boundaries
  startDate DateTime
  endDate   DateTime
  timezone  String   @default("UTC")

  // Participation rules
  maxParticipants     Int? // Null = unlimited
  minAge              Int? // Age restriction
  eligibleCustomerIds String[] // Specific customers (empty = all)
  eligibleTiers       String[] // Specific loyalty tiers (empty = all)

  // AI-generated metadata (for AI challenges)
  aiGenerated Boolean @default(false)
  aiPrompt    String? // Original prompt used to generate
  aiModel     String? // "gpt-4o", "custom-challenge-v1"

  // Viral prediction
  predictedViralScore    Float? @default(0) // AI-predicted viral coefficient (K-factor)
  predictedReach         Int? // Estimated impressions
  predictedParticipation Float? // Estimated % of customers who participate

  // Actual performance metrics (updated during/after challenge)
  totalParticipants Int    @default(0)
  totalSubmissions  Int    @default(0)
  totalShares       Int    @default(0)
  totalImpressions  Int    @default(0) // Social media impressions
  actualViralScore  Float? // Calculated K-factor
  actualReach       Int    @default(0)

  // Media assets
  coverImageUrl        String?
  exampleVideoUrl      String? // Example of what to submit
  instructionsVideoUrl String?

  // Relations
  participations ChallengeParticipation[]
  leaderboard    ChallengeLeaderboard[]

  // Audit
  createdBy String // User ID
  updatedBy String?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@index([businessId, status])
  @@index([startDate, endDate])
  @@index([trendSource])
  @@index([predictedViralScore])
  @@map("challenges")
}

// ============================================================================
// CHALLENGE PARTICIPATION
// ============================================================================

enum ParticipationStatus {
  JOINED // Customer joined, not yet completed
  IN_PROGRESS // Actively working on tasks
  COMPLETED // All tasks completed
  ABANDONED // Started but didn't finish
  DISQUALIFIED // Broke rules
}

model ChallengeParticipation {
  id String @id @default(cuid())

  // Relations
  challengeId String
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  businessId String // Denormalized for query performance
  customerId String

  // Progress tracking
  status         ParticipationStatus @default(JOINED)
  tasksCompleted Json // Which tasks completed
  // Example: {
  //   "purchase": {"completed": true, "completedAt": "2025-11-10T12:00:00Z"},
  //   "photo_upload": {"completed": true, "submissionId": "ugc_123"},
  //   "social_share": {"completed": true, "shareUrl": "https://instagram.com/p/..."}
  // }

  // Submission tracking
  submissionIds String[] // UGC submission IDs
  shareUrls     String[] // Social media share URLs

  // Engagement metrics
  sharesGenerated      Int @default(0) // How many friends joined via this customer
  impressionsGenerated Int @default(0) // Estimated social impressions

  // Rewards earned
  pointsEarned Int      @default(0)
  badgesEarned String[] // Badge IDs
  prizesWon    Json? // Special prizes for top performers

  // Leaderboard position
  rank  Int? // Position on leaderboard (1st, 2nd, etc.)
  score Float? // Calculated score for ranking
  // Example score calculation:
  // - Task completion: 100 points
  // - Share count: 50 points per share
  // - Engagement: 10 points per 1K impressions

  // Timestamps
  joinedAt    DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt

  @@unique([challengeId, customerId])
  @@index([businessId, customerId])
  @@index([status])
  @@index([rank])
  @@map("challenge_participations")
}

// ============================================================================
// CHALLENGE LEADERBOARD
// ============================================================================

// Separate table for performance optimization (denormalized leaderboard view)
model ChallengeLeaderboard {
  id String @id @default(cuid())

  // Relations
  challengeId String
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  customerId String
  businessId String // Denormalized

  // Leaderboard metrics
  rank        Int
  score       Float
  points      Int // Points earned in this challenge
  shares      Int // Social shares generated
  impressions Int // Social impressions generated

  // Customer display info (denormalized for performance)
  customerName   String
  customerAvatar String?

  // Timestamps
  updatedAt DateTime @updatedAt

  @@unique([challengeId, customerId])
  @@index([challengeId, rank])
  @@index([businessId])
  @@map("challenge_leaderboards")
}

// ============================================================================
// NOTES
// ============================================================================
//
// AI Viral Challenge Builder Workflow:
// 1. Business clicks "Create Viral Challenge"
// 2. AI scrapes TikTok/Instagram trending API
// 3. AI suggests 5 trending challenge formats:
//    - "POV: You're a [role]" (trending format)
//    - "Day in the life" (evergreen format)
//    - "Before/After transformation" (viral format)
//    - Music/dance challenges (if trending sound detected)
// 4. Business selects one, customizes rewards
// 5. AI generates hashtag, task description, example video
// 6. Challenge goes live, customers participate
// 7. AI tracks viral coefficient in real-time
//
// Viral Coefficient Calculation:
// K = (Total Participants) / (Initial Participants) over time period
// - If 100 customers join initially
// - And they generate 150 new customers via shares
// - K = 150/100 = 1.5 (VIRAL!)
//
// Leaderboard Ranking Algorithm:
// Score = (Task Completion × 100) + (Shares × 50) + (Impressions / 1000 × 10)
// - Encourages both completion AND virality
// - Top 10 get special prizes
// - Public leaderboard creates FOMO/competition
//
// Hashtag Strategy:
// - Brand hashtag: #BrandNameChallenge (always required)
// - Trend hashtag: #TrendingTopic (if AI-detected trend)
// - Custom hashtag: Business can add custom tag
// - AI tracks all three across platforms
//
// Multi-Tenant Safety:
// - Each business has isolated challenges
// - No cross-business leaderboards
// - Customers can only see challenges from businesses they're members of
//
// Performance Optimization:
// - Leaderboard denormalized to separate table
// - Updated via background job (every 5 minutes during active challenge)
// - Read-optimized for real-time display
