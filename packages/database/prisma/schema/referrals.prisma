// Referral Program Domain
// Models: Referral, ReferralCode, ReferralReward, ReferralAnalytics
//
// Purpose: Enable viral growth through customer referrals with dual-sided
// incentives, tracking, and viral coefficient analytics. Designed to achieve
// K-factor of 0.5-0.7 for sustainable viral growth.

// ============================================================================
// REFERRAL CODES
// ============================================================================

enum CodeType {
  PERSONAL // Individual customer code (e.g., "SARAH20")
  CAMPAIGN // Campaign-specific code (e.g., "SUMMER2025")
  INFLUENCER // Influencer/ambassador code
  PARTNER // Partner business code
}

enum CodeStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  SUSPENDED // Temporarily disabled (fraud detection)
}

model ReferralCode {
  id String @id @default(cuid())

  // Multi-tenant
  businessId String

  // Code details
  code   String // "SARAH20", "FRIEND10", etc.
  type   CodeType
  status CodeStatus @default(ACTIVE)

  // Owner (who can share this code)
  ownerId   String // Customer ID or influencer ID
  ownerType String // "customer", "influencer", "partner"

  // Usage limits
  maxUses            Int? // Null = unlimited
  currentUses        Int  @default(0)
  maxUsesPerCustomer Int? @default(1) // How many times same person can use

  // Time boundaries
  validFrom  DateTime  @default(now())
  validUntil DateTime? // Null = no expiration

  // Rewards (dual-sided incentives)
  referrerReward Json // Reward for person sharing code
  // Example: {"type": "points", "amount": 100, "description": "100 points per friend"}

  referredReward Json // Reward for person using code
  // Example: {"type": "discount", "amount": 10, "unit": "percent", "description": "10% off first order"}

  // Requirements (conditions to earn reward)
  requirements Json?
  // Example: {
  //   "minPurchaseAmount": 50,
  //   "firstPurchaseOnly": true,
  //   "eligibleProductIds": ["prod_123", "prod_456"]
  // }

  // Performance tracking
  clickCount      Int   @default(0) // How many people clicked link
  conversionCount Int   @default(0) // How many completed purchase
  conversionRate  Float @default(0) // conversionCount / clickCount
  totalRevenue    Float @default(0) // Total revenue generated
  avgOrderValue   Float @default(0) // Average order from referrals

  // Viral metrics
  viralCoefficient Float @default(0) // K-factor for this code
  // K = (Number of successful referrals) / (Total possible if owner invited all contacts)
  // Approximation: K = conversionCount / (clickCount * 0.2) assuming 20% is owner's reach

  secondaryReferrals Int @default(0) // Referrals generated by referred customers
  // If Sarah refers John, and John refers Mike â†’ Mike is secondary referral

  // Channel tracking
  shareChannels Json? // Which channels code was shared to
  // Example: ["instagram", "whatsapp", "email", "sms"]

  lastSharedAt DateTime?
  lastUsedAt   DateTime?

  // Relations
  referrals Referral[]
  rewards   ReferralReward[]
  analytics ReferralAnalytics?

  // Audit
  createdBy String // User ID who created this code
  updatedBy String?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@unique([businessId, code])
  @@index([businessId, ownerId])
  @@index([status])
  @@index([viralCoefficient])
  @@map("referral_codes")
}

// ============================================================================
// REFERRALS (Individual referral events)
// ============================================================================

enum ReferralStatus {
  PENDING // Code used, awaiting purchase completion
  QUALIFIED // Referred customer completed qualifying action
  REWARDED // Rewards distributed to both parties
  EXPIRED // Did not complete within time window
  CANCELLED // Cancelled (e.g., refund, fraud)
  FRAUDULENT // Flagged as fraud
}

model Referral {
  id String @id @default(cuid())

  // Relations
  businessId String
  codeId     String
  code       ReferralCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  // Parties involved
  referrerId String // Customer who shared code (owner of code)
  referredId String? // Customer who used code (null until they sign up)

  // Tracking
  status ReferralStatus @default(PENDING)

  // Attribution
  clickedAt   DateTime? // When link was clicked
  signedUpAt  DateTime? // When referred customer signed up
  qualifiedAt DateTime? // When qualifying action completed (first purchase)

  // Click metadata
  ipAddress   String?
  userAgent   String?
  referrer    String? // HTTP referrer
  utmSource   String? // UTM parameters for tracking
  utmMedium   String?
  utmCampaign String?
  channel     String? // "instagram", "email", "sms", "whatsapp"

  // Conversion tracking
  orderId    String? // First order placed by referred customer
  orderValue Float? // Value of first order
  orderDate  DateTime?

  // Rewards distributed
  referrerRewardId String? // Reward given to referrer
  referredRewardId String? // Reward given to referred customer

  // Fraud detection
  fraudScore Float? // 0-100, higher = more suspicious
  fraudFlags String[] // ["same_ip", "velocity_anomaly", "device_fingerprint_match"]

  // Relations
  rewards ReferralReward[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, referrerId])
  @@index([businessId, referredId])
  @@index([codeId])
  @@index([status])
  @@map("referrals")
}

// ============================================================================
// REFERRAL REWARDS (Rewards distributed)
// ============================================================================

enum RewardType {
  POINTS
  DISCOUNT
  FREE_PRODUCT
  CASH
  UPGRADE // Tier upgrade
  BONUS_ENTRY // Contest entry
}

enum RewardStatus {
  PENDING // Reward earned, not yet distributed
  DISTRIBUTED // Reward given to customer
  REDEEMED // Customer used the reward
  EXPIRED // Reward expired before use
  CANCELLED // Reward cancelled (fraud, refund)
}

model ReferralReward {
  id String @id @default(cuid())

  // Relations
  businessId String
  codeId     String
  code       ReferralCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  referralId String?
  referral   Referral? @relation(fields: [referralId], references: [id], onDelete: SetNull)

  // Recipient
  customerId    String // Who receives this reward
  recipientType String // "referrer" or "referred"

  // Reward details
  type   RewardType
  status RewardStatus @default(PENDING)

  amount      Float? // Numeric value (points, dollars, discount %)
  productId   String? // Free product ID
  description String

  // Lifecycle
  earnedAt      DateTime  @default(now())
  distributedAt DateTime?
  redeemedAt    DateTime?
  expiresAt     DateTime?

  // Metadata
  metadata Json? // Additional reward-specific data

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, customerId])
  @@index([codeId])
  @@index([status])
  @@map("referral_rewards")
}

// ============================================================================
// REFERRAL ANALYTICS (Denormalized analytics view)
// ============================================================================

// Real-time analytics dashboard for each referral code
model ReferralAnalytics {
  id String @id @default(cuid())

  // Relations
  codeId String       @unique
  code   ReferralCode @relation(fields: [codeId], references: [id], onDelete: Cascade)

  businessId String

  // Funnel metrics
  clicks    Int @default(0)
  signups   Int @default(0)
  purchases Int @default(0)

  // Conversion rates
  clickToSignupRate    Float @default(0) // signups / clicks
  signupToPurchaseRate Float @default(0) // purchases / signups
  clickToPurchaseRate  Float @default(0) // purchases / clicks (overall conversion)

  // Revenue metrics
  totalRevenue  Float @default(0)
  avgOrderValue Float @default(0)
  customerLTV   Float @default(0) // Estimated LTV of referred customers

  // Viral metrics
  primaryReferrals   Int @default(0) // Direct referrals from code owner
  secondaryReferrals Int @default(0) // Referrals from referred customers
  tertiaryReferrals  Int @default(0) // Third-level referrals

  viralCoefficient Float @default(0) // K-factor
  // K = (primaryReferrals + secondaryReferrals) / primaryReferrals
  // If K > 1.0, it's truly viral (each referral brings >1 more)

  viralCycleTime Float? @default(0) // Avg days from referral to next referral
  // Faster cycle time = faster growth

  // Channel breakdown (JSON for flexibility)
  channelPerformance Json? @default("{}")
  // Example: {
  //   "instagram": {"clicks": 50, "conversions": 10, "conversionRate": 0.2},
  //   "whatsapp": {"clicks": 30, "conversions": 12, "conversionRate": 0.4},
  //   "email": {"clicks": 20, "conversions": 5, "conversionRate": 0.25}
  // }

  // Time-series data (last 30 days)
  dailyMetrics Json? @default("[]")
  // Example: [
  //   {"date": "2025-11-01", "clicks": 5, "conversions": 2},
  //   {"date": "2025-11-02", "clicks": 8, "conversions": 3}
  // ]

  // Top performers (for influencer/partner codes)
  topReferrers Json? @default("[]")
  // Example: [
  //   {"customerId": "cust_123", "conversions": 15, "revenue": 1500},
  //   {"customerId": "cust_456", "conversions": 12, "revenue": 1200}
  // ]

  // Last updated
  lastCalculatedAt DateTime @default(now())

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([viralCoefficient])
  @@map("referral_analytics")
}

// ============================================================================
// NOTES
// ============================================================================
//
// Referral Code Generation Strategies:
// 1. Personal: FirstName + Random Number (e.g., "SARAH142")
// 2. Memorable: Dictionary words (e.g., "SPARKLE20", "SUNSET50")
// 3. Branded: Brand + Verb (e.g., "BREWLOVE", "SHOPNOW")
//
// Dual-Sided Incentive Examples:
// - Referrer: 100 points for each friend who makes first purchase
// - Referred: $10 off first order of $50+
// - Both: Win-win creates motivation to share AND use
//
// Viral Coefficient Calculation (K-Factor):
// K = (Total Referrals) / (Total Possible Referrals)
//
// Simplified: K = Conversions / Initial Customers
// - K < 1.0: Sub-viral (still good, reduces CAC)
// - K = 1.0: Self-sustaining (each customer brings 1 more)
// - K > 1.0: Viral (exponential growth)
//
// Target K-Factor for NxLoy: 0.5-0.7
// - This means each customer brings 0.5-0.7 more customers
// - Reduces CAC by 50-70%
// - Sustainable growth without paid ads
//
// Fraud Detection Signals:
// 1. Same IP address for referrer and referred
// 2. Device fingerprint matches (same browser/device)
// 3. Velocity anomaly (100 referrals in 1 hour = bot)
// 4. Email pattern matching (sarah1@, sarah2@, sarah3@ = fake accounts)
// 5. Purchase pattern (referred customer never buys again = gaming system)
//
// Fraud Mitigation:
// - Delay reward distribution until qualifying action (30-day purchase window)
// - Human review for high-value rewards (>$100)
// - Blacklist suspicious IP ranges
// - Limit referrals per customer (max 50/month)
//
// Channel Attribution:
// - Instagram: Track via UTM parameters or unique link
// - WhatsApp: Detect via user agent
// - Email: Track via email client headers
// - SMS: Track via SMS gateway webhook
//
// Analytics Update Frequency:
// - Real-time: For clicks, signups (immediate writes)
// - Batch: For analytics table (update every 5 minutes via cron job)
// - Denormalization trades write cost for read speed
//
// Multi-Tenant Safety:
// - Each business has isolated referral codes
// - No cross-business referrals
// - Analytics scoped by businessId
//
// Performance Optimization:
// - ReferralAnalytics table is denormalized for fast dashboard loads
// - Updated via background job (not real-time)
// - Separate table prevents slow aggregation queries on live data
